<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro y Configuración de Eventos - EventosPro</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- CSS Global y específico -->
  <link rel="stylesheet" href="CSS/styleIndex.css">
  <link rel="stylesheet" href="CSS/styleCrearEvento.css">
</head>
<body class="d-flex flex-column min-vh-100">
  
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top bg-primary">
    <div class="container">
      <a class="navbar-brand" href="index.html">EventosPro - Organizador</a>
      <div class="collapse navbar-collapse" id="navbarCrearEvento">
        <div class="ms-auto">
          <a href="organ.html" class="btn btn-secondary-custom">Regresar</a>
        </div>
      </div>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCrearEvento" 
              aria-controls="navbarCrearEvento" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>

  <!-- Contenido principal -->
  <main class="flex-fill py-4">
    <div class="container">
      <h2 class="text-center mb-4">Registro y Configuración de Eventos</h2>
      <form id="eventForm" class="bg-white p-4 rounded shadow-sm">
        <!-- Detalles del Evento -->
        <section class="mb-4">
          <h3 class="mb-3">Detalles del Evento</h3>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="eventName" class="form-label">Nombre del Evento</label>
              <input type="text" id="eventName" name="eventName" placeholder="Nombre del evento" required class="form-control">
            </div>
            <div class="col-md-6">
              <label for="category" class="form-label">Categoría</label>
              <select id="category" name="category" required class="form-select">
                <option value="" disabled selected>Seleccione una categoría</option>
                <option value="deportivo">Deportivo</option>
                <option value="cultural">Cultural</option>
                <option value="educativo">Educativo</option>
                <option value="social">Social</option>
              </select>
            </div>
            <div class="col-12">
              <label for="description" class="form-label">Descripción</label>
              <textarea id="description" name="description" rows="4" placeholder="Descripción del evento" required class="form-control"></textarea>
            </div>
            <div class="col-md-12">
              <label for="dateTime" class="form-label">Fecha y Hora</label>
              <input type="datetime-local" id="dateTime" name="dateTime" required class="form-control">
              <input type="hidden" id="userId" name="userId" value="">
            </div>
          </div>
        </section>
        
        <!-- Asignación de Sedes -->
        <section class="mb-4">
          <h3 class="mb-3">Asignación de Sedes</h3>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="venueSelect" class="form-label">Nombre de la Sede</label>
              <select id="venueSelect" name="venueSelect" required class="form-select">
                <option value="" disabled selected>Seleccione una sede</option>
                <!-- Las opciones se agregarán posteriormente -->
              </select>
            </div>
            <div class="col-md-6">
              <label for="capacity" class="form-label">Capacidad</label>
              <input type="number" id="capacity" name="capacity" placeholder="Número máximo de asistentes" min="1" required class="form-control">
            </div>
          </div>
        </section>
        
        <!-- Métodos de Inscripción -->
        <section class="mb-4">
          <h3 class="mb-3">Métodos de Inscripción</h3>
          <div class="mb-2">
            <label class="form-label">Tipo de Inscripción</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="registrationType" id="registrationGratis" value="gratis" checked>
              <label class="form-check-label" for="registrationGratis">Gratis</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="registrationType" id="registrationPago" value="pago">
              <label class="form-check-label" for="registrationPago">Pago</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="registrationType" id="registrationInvitacion" value="invitacion">
              <label class="form-check-label" for="registrationInvitacion">Por Invitación</label>
            </div>
          </div>
          <div id="priceContainer" class="mb-3 d-none">
            <label for="price" class="form-label">Precio (MXN)</label>
            <input type="number" id="price" name="price" placeholder="Precio de la inscripción" min="0" step="0.01" class="form-control">
          </div>
        </section>
        
        <div class="text-center">
          <button type="submit" class="btn btn-primary-custom px-4 py-2">Registrar Evento</button>
        </div>
      </form>
    </div>
  </main>
  
  <!-- Footer -->
  <footer class="bg-indigo-600 text-white py-6">
    <div class="container">
      <div class="row">
        <div class="col-md-4 mb-4">
          <h3>EventosPro</h3>
          <p>La plataforma líder para la creación y gestión de eventos. Conectamos organizadores con participantes para experiencias inolvidables.</p>
        </div>
        <div class="col-md-2 mb-4">
          <h5>Enlaces Rápidos</h5>
          <div class="footer-links">
            <a href="index.html" class="text-white">Inicio</a>
            <a href="index.html" class="text-white">Eventos</a>
            <a href="index.html" class="text-white">Sobre Nosotros</a>
            <a href="index.html" class="text-white">Contacto</a>
            <a href="index.html" class="text-white">Política de Privacidad</a>
          </div>
        </div>
        <div class="col-md-3 mb-4">
          <h5>Contacto</h5>
          <p><i class="fas fa-map-marker-alt me-2"></i> Universidad de Colima, Facultad de Telemática</p>
          <p><i class="fas fa-phone me-2"></i> +123 456 7890</p>
          <p><i class="fas fa-envelope me-2"></i> infoeventos@gmail.com</p>
        </div>
        <div class="col-md-3 mb-4">
          <h5>Síguenos</h5>
          <div class="social-icons">
            <a href="#" class="text-white me-3"><i class="fab fa-facebook"></i></a>
            <a href="#" class="text-white me-3"><i class="fab fa-twitter"></i></a>
            <a href="#" class="text-white me-3"><i class="fab fa-instagram"></i></a>
            <a href="#" class="text-white"><i class="fab fa-linkedin"></i></a>
          </div>
        </div>
      </div>
      <hr class="mt-4 mb-4" style="border-color: rgba(255,255,255,0.1);">
      <div class="text-center">
        <p class="mb-0">© 2025 EventosPro. Todos los derechos reservados.</p>
      </div>
    </div>
  </footer>
  
<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Cargar sedes y configurar eventos al iniciar
  document.addEventListener('DOMContentLoaded', async () => {
    await cargarSedes();
    togglePriceInput();
    setupCapacityValidation();
  });

  const storedUserData = localStorage.getItem("userData");
  const userData = JSON.parse(storedUserData); 
  const userId = userData.id;
  console.log(userId); 

  // Función para cargar sedes desde la API
  async function cargarSedes() {
    try {
      const response = await fetch('http://localhost:3000/api/sede');
      if (!response.ok) throw new Error('Error al cargar sedes');
      
      const sedes = await response.json();
      const select = document.getElementById('venueSelect');
      
      select.innerHTML = '<option value="" disabled selected>Seleccione una sede</option>';
      
      sedes.forEach(sede => {
        const option = document.createElement('option');
        option.value = sede.id;
        option.textContent = `${sede.nombre} (Cap. Máx: ${sede.capacidad})`;
        option.dataset.capacidad = sede.capacidad;
        select.appendChild(option);
      });
    } catch (error) {
      console.error('Error al cargar sedes:', error);
      document.getElementById('venueSelect').innerHTML = 
        '<option value="" disabled selected>Error al cargar sedes</option>';
    }
  }

  // Configurar validación de capacidad en tiempo real
  function setupCapacityValidation() {
    const capacityInput = document.getElementById('capacity');
    const venueSelect = document.getElementById('venueSelect');

    venueSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (selectedOption.value) {
        capacityInput.max = selectedOption.dataset.capacidad;
        capacityInput.placeholder = `Máximo: ${selectedOption.dataset.capacidad}`;
      }
    });

    capacityInput.addEventListener('input', function() {
      const selectedOption = venueSelect.options[venueSelect.selectedIndex];
      if (selectedOption && selectedOption.value) {
        const maxCapacity = parseInt(selectedOption.dataset.capacidad);
        const currentCapacity = parseInt(this.value) || 0;
        
        if (currentCapacity > maxCapacity) {
          this.classList.add('is-invalid');
          showCapacityError(`La capacidad no puede exceder ${maxCapacity}`);
        } else {
          this.classList.remove('is-invalid');
          hideCapacityError();
        }
      }
    });
  }

  // Mostrar error de capacidad
  function showCapacityError(message) {
    let errorElement = document.getElementById('capacityError');
    if (!errorElement) {
      errorElement = document.createElement('div');
      errorElement.id = 'capacityError';
      errorElement.className = 'invalid-feedback';
      document.getElementById('capacity').after(errorElement);
    }
    errorElement.textContent = message;
  }

  // Ocultar error de capacidad
  function hideCapacityError() {
    const errorElement = document.getElementById('capacityError');
    if (errorElement) {
      errorElement.remove();
    }
  }

  // Manejo del envío del formulario
  document.getElementById('eventForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Limpiar errores previos
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    hideCapacityError();

    // Determinar el precio basado en la selección
    const tipoInscripcion = document.querySelector('input[name="registrationType"]:checked').value;
    let precio = 0;
    
    if (tipoInscripcion === 'pago') {
      precio = document.getElementById('price').value || 0;
    }

    const formData = {
      nombre: document.getElementById('eventName').value,
      descripcion: document.getElementById('description').value,  // Cambiado de description a descripcion
      categoria: document.getElementById('category').value,
      fechayhora: document.getElementById('dateTime').value,
      sede: document.getElementById('venueSelect').value,
      capacidad: document.getElementById('capacity').value,
      precio: precio,
      id_usuario: userId, // Usar userId del localStorage
    };

    try {
      const response = await fetch('http://localhost:3000/api/eventos', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });

      // Log para depuración
      console.log("Datos a enviar:", formData);

      if (!response.ok) {
        const errorData = await response.json();
        
        // Manejar error de capacidad
        if (errorData.message && errorData.message.includes('La capacidad excede')) {
          document.getElementById('capacity').classList.add('is-invalid');
          showCapacityError(errorData.message);
          return;
        }
        
        throw new Error(errorData.message || 'Error al registrar evento');
      }

      if (!response.ok) {
        const errorData = await response.json();
        
        // Mostrar errores de validación de campos
        if (errorData.message && errorData.message.includes('Faltan campos')) {
          const campoFaltante = errorData.message.match(/'(.*?)'/)[1];
          alert(`Por favor complete el campo: ${campoFaltante}`);
          return;
        }
  
        throw new Error(errorData.message || 'Error al registrar evento');
      }

      const result = await response.json();
      alert(`Evento registrado con éxito!`);
      e.target.reset();
      
    } catch (error) {
      console.error('Error:', error);
      alert(`Error: ${error.message}`);
    }
  });

  // Toggle para el campo de precio
  const registrationRadios = document.querySelectorAll('input[name="registrationType"]');
  const priceContainer = document.getElementById('priceContainer');
  const priceInput = document.getElementById('price');

  function togglePriceInput() {
    const selected = document.querySelector('input[name="registrationType"]:checked').value;
    if (selected === 'pago') {
      priceContainer.classList.remove('d-none');
      priceInput.setAttribute('required', 'required');
    } else {
      priceContainer.classList.add('d-none');
      priceInput.removeAttribute('required');
      priceInput.value = '';
    }
  }

  registrationRadios.forEach(radio => {
    radio.addEventListener('change', togglePriceInput);
  });
</script>
</body>
</html>